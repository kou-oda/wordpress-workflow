name: WordPress è‡ªå‹•æŠ•ç¨¿

on:
  # æ¯æ—¥åˆå‰9æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã«å®Ÿè¡Œ - UTCã§ã¯åˆå‰0æ™‚
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥ UTC 0:00 (JST 9:00)

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: æœªæŠ•ç¨¿ã®è¨˜äº‹ã‚’æ¤œç´¢
        id: find-post
        run: |
          # posts/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰.mdãƒ•ã‚¡ã‚¤ãƒ«ã§ã€ã¾ã .publishedãƒ•ãƒ©ã‚°ãŒãªã„ã‚‚ã®ã‚’æ¤œç´¢
          unpublished_posts=$(find posts -name "*.md" -type f | while read -r post; do
            if [ ! -f "${post}.published" ]; then
              echo "$post"
            fi
          done | sort | head -n 1)

          if [ -z "$unpublished_posts" ]; then
            echo "æœªæŠ•ç¨¿ã®è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "post_found=false" >> $GITHUB_OUTPUT
          else
            echo "æŠ•ç¨¿ã™ã‚‹è¨˜äº‹: $unpublished_posts"
            echo "post_found=true" >> $GITHUB_OUTPUT
            echo "post_path=$unpublished_posts" >> $GITHUB_OUTPUT
          fi

      - name: WordPressã«æŠ•ç¨¿
        if: steps.find-post.outputs.post_found == 'true'
        env:
          WORDPRESS_URL: ${{ secrets.WORDPRESS_URL }}
          WORDPRESS_USERNAME: ${{ secrets.WORDPRESS_USERNAME }}
          WORDPRESS_APP_PASSWORD: ${{ secrets.WORDPRESS_APP_PASSWORD }}
        run: |
          node scripts/publish-to-wordpress.js "${{ steps.find-post.outputs.post_path }}"

      - name: æŠ•ç¨¿æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: steps.find-post.outputs.post_found == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add "${{ steps.find-post.outputs.post_path }}.published"
          git commit -m "ğŸ“ æŠ•ç¨¿å®Œäº†: ${{ steps.find-post.outputs.post_path }}"
          git push
